name: ðŸŒDevSecOps - Full Security Pipeline
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # 1) SAST - Semgrep (ne bloque pas, upload rapports)
  sast:
    name: ðŸ”Ž SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep and produce reports
        run: |
          # Remplace par ton fichier de rÃ¨gles si besoin (ou --config=p/r2c)
          semgrep --config=.semgrep/java-password-sql.yml --json --output=semgrep-report.json || true
          semgrep --config=.semgrep/java-password-sql.yml --text --output=semgrep-report.txt || true
          echo "Semgrep finished (reports created if rules matched)."

      - name: Upload Semgrep reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep-report.json
            semgrep-report.txt

  # 2) SCA - OWASP Dependency-Check (gÃ©nÃ¨re rapports; ne bloque pas)
  dependency_check:
    name: ðŸ§© SCA - OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (temurin)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Dependency-Check CLI
        run: |
          DC_VER="10.0.3"
          wget -q "https://github.com/jeremylong/DependencyCheck/releases/download/v${DC_VER}/dependency-check-${DC_VER}-release.zip" -O dc.zip
          unzip -q dc.zip -d dc
          ls -la dc

      - name: Run Dependency-Check (scan repo)
        run: |
          chmod +x dc/dependency-check/bin/dependency-check.sh
          ./dc/dependency-check/bin/dependency-check.sh \
            --project "devops-project" \
            --scan . \
            --format "ALL" \
            --out dependency-check || true

      - name: Upload Dependency-Check reports (s'il y en a)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: |
            dependency-check/dependency-check-report.html
            dependency-check/dependency-check-report.xml
            dependency-check/dependency-check-report.json

  # 3) Docker image build + Trivy (scan non-fatal)
  docker_scan:
    name: ðŸ³ Docker Build & Trivy
    runs-on: ubuntu-latest
    needs: dependency_check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "Building docker image..."
          docker build -t devsecops-demo:latest .

      - name: Scan image with Trivy (report)
        uses: aquasecurity/trivy-action@v0.16.0
        with:
          image-ref: devsecops-demo:latest
          format: json
          output: trivy-report.json
          exit-code: '0'   # 0 => do not fail pipeline on findings
          scan-type: image

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

  # 4) DAST - OWASP ZAP baseline (artifact name valid, upload)
  dast:
    name: ðŸŒ DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: docker_scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP baseline
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://testphp.vulnweb.com"
          cmd_options: "-a -T 5"
          allow_issue_writing: false

      - name: Upload ZAP reports (artifact name must be valid)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_md.md
            report_json.json

      - name: ZAP summary
        if: always()
        run: echo "ZAP finished; reports uploaded as artifact 'zap-report'."

  # 5) Secrets scan - Gitleaks
  secrets_scan:
    name: ðŸ” Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: dast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gitleaks scan
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source . --report-format json --report-path=gitleaks-report.json || true

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # 6) SonarQube (optionnel) - n'exÃ©cute que si secrets SONAR_TOKEN et SONAR_HOST_URL prÃ©sents
  sonar:
    name: ðŸ” SonarQube Scan (optionnel)
    runs-on: ubuntu-latest
    needs: [sast, dependency_check, docker_scan, dast, secrets_scan]
    if: ${{ secrets.SONAR_TOKEN != '' && secrets.SONAR_HOST_URL != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: SonarQube scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=SonarQube-GITHUB
            -Dsonar.projectName=SonarQube-GITHUB

      - name: Sonar done
        run: echo "Sonar scan submitted (if secrets provided)."
