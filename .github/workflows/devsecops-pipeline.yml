name: DevSecOps - Full Security Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: devsecops-pipeline
  cancel-in-progress: true

jobs:

  # ----------------------
  # 1) SAST - Semgrep
  # ----------------------
  sast:
    name: ðŸ”Ž SAST - Semgrep Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep (JSON + text)
        id: semgrep
        run: |
          semgrep --config=p/r2c --json --output=semgrep-report.json || true
          semgrep --config=p/r2c --markdown --output=semgrep-report.md || true
          semgrep --config=p/r2c --text --output=semgrep-report.txt || true
          # si semgrep-report.json contient au moins une "check_id" -> exit 1 pour bloquer
          if [ -f semgrep-report.json ] && grep -q '"check_id"' semgrep-report.json; then
            echo "âŒ VulnÃ©rabilitÃ©s dÃ©tectÃ©es par Semgrep !"
            echo "Voir semgrep-report.md / semgrep-report.json pour dÃ©tails."
            exit 1
          else
            echo "âœ… Semgrep: no findings"
          fi

      - name: Upload Semgrep reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep-report.json
            semgrep-report.md
            semgrep-report.txt

  # ----------------------
  # 2) SCA - OWASP Dependency-Check
  # ----------------------
  dependency_check:
    name: ðŸ§© SCA - OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (dependency-check requires Java)
        uses: actions/setup-java@v4
        with:
          java-version: '17'

      - name: Install OWASP Dependency-Check CLI
        run: |
          curl -sSL https://github.com/jeremylong/DependencyCheck/releases/latest/download/dependency-check-7.6.0-release.zip -o dc.zip
          unzip -q dc.zip -d dc
          chmod +x dc/dependency-check/bin/dependency-check.sh

      - name: Run OWASP Dependency-Check
        run: |
          ./dc/dependency-check/bin/dependency-check.sh --project "devops-project" --format ALL --scan . --out dependency-check-report || true

      - name: Upload Dependency-Check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: |
            dependency-check-report.html
            dependency-check-report.xml
            dependency-check-report.json

  # ----------------------
  # 3) Docker image build + Trivy scan
  # ----------------------
  docker_scan:
    name: ðŸ³ Docker Image Scan - Trivy
    runs-on: ubuntu-latest
    needs: dependency_check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "ðŸ—ï¸ Construction de l'image Docker..."
          docker build -t devops-scan-image:latest .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@v2
        with:
          image-ref: devops-scan-image:latest
          format: table
          output: trivy-report.txt
          exit-code: '1' # 0=pass, 1=fail on vuln found (change si tu veux seulement signaler)
          scan-type: image

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt

  # ----------------------
  # 4) DAST - OWASP ZAP
  # ----------------------
  dast:
    name: ðŸŒ DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: docker_scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP baseline (site de test)
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://testphp.vulnweb.com"
          cmd_options: "-a -T 5"
          allow_issue_writing: false   # Ã©vite que ZAP tente d'Ã©crire dans le repo (permission)

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_md.md
            report_json.json

      - name: ZAP summary (console)
        if: always()
        run: |
          echo "ZAP Scan terminÃ©. Rapports uploadÃ©s."

  # ----------------------
  # 5) Secrets Scan - Gitleaks
  # ----------------------
  secrets_scan:
    name: ðŸ” Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: dast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_$(uname -s)_$(uname -m).tar.gz | tar -xz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks || true

      - name: Run gitleaks (scan)
        run: |
          gitleaks detect --source . --report-path=gitleaks-report.json || true

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ----------------------
  # 6) SonarQube Analysis
  # ----------------------
  sonar:
    name: ðŸ” SonarQube Scan
    runs-on: ubuntu-latest
    needs: [sast, dependency_check, docker_scan, dast, secrets_scan]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: SonarQube scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=SonarQube-GITHUB
            -Dsonar.projectName=SonarQube-GITHUB

      - name: SonarQube - done
        run: echo "SonarQube scan submitted."

