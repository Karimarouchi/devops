name: ğŸ” DevSecOps - Full Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# ğŸ”’ Permissions nÃ©cessaires pour GitHub Actions
permissions:
  contents: read
  actions: write
  security-events: write

jobs:
  # 1ï¸âƒ£ SAST - Analyse statique du code source
  sast:
    name: ğŸ” SAST - Semgrep Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Installer Semgrep
        run: pip install semgrep

      - name: ğŸš€ ExÃ©cuter l'analyse Semgrep
        run: |
          semgrep --config=.semgrep/java-password-sql.yml --json -o semgrep-report.json || true
          semgrep --config=.semgrep/java-password-sql.yml --text -o semgrep-report.txt || true

      - name: â›” Ã‰chec si vulnÃ©rabilitÃ©s dÃ©tectÃ©es
        run: |
          if grep -q '"check_id"' semgrep-report.json; then
            echo "âŒ VulnÃ©rabilitÃ©s dÃ©tectÃ©es par Semgrep !"
            exit 1
          fi

      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep-report.json
            semgrep-report.txt

  # 2ï¸âƒ£ SCA - Analyse des dÃ©pendances
  sca:
    name: ğŸ§© SCA - OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: âš™ï¸ Installer OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip
          unzip dependency-check-10.0.3-release.zip
          mv dependency-check /opt/dependency-check
          chmod +x /opt/dependency-check/bin/dependency-check.sh

      - name: ğŸš€ Lancer Dependency Check
        run: |
          /opt/dependency-check/bin/dependency-check.sh \
            --project "DevSecOps-Demo" \
            --scan ./ \
            --format "ALL" \
            --out dependency-report || true

      - name: â›” Ã‰chec si vulnÃ©rabilitÃ©s critiques
        run: |
          if grep -q "CRITICAL" dependency-report/dependency-check-report.html; then
            echo "âŒ VulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es !"
            exit 1
          fi

      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report

  # 3ï¸âƒ£ Secrets - Analyse de fuites de secrets
  secrets:
    name: ğŸ”’ Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: sca
    steps:
      - uses: actions/checkout@v4

      - name: ğŸš€ ExÃ©cuter Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format json --report-path gitleaks-report.json || true

      - name: â›” Ã‰chec si secrets trouvÃ©s
        run: |
          if grep -q '"Description"' gitleaks-report.json; then
            echo "âŒ Secrets dÃ©tectÃ©s dans le dÃ©pÃ´t !"
            exit 1
          fi

      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # 4ï¸âƒ£ Docker Scan - Trivy (scan de lâ€™image container)
  docker_scan:
    name: ğŸ³ Docker Image Scan - Trivy
    runs-on: ubuntu-latest
    needs: secrets
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: âš™ï¸ Construire lâ€™image Docker
        run: docker build -t devsecops-demo:latest .

      - name: ğŸš€ Lancer le scan Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "devsecops-demo:latest"
          format: "json"
          output: "docker-scan.json"
          exit-code: "0"

      - name: â›” Ã‰chec si vulnÃ©rabilitÃ©s critiques
        run: |
          if grep -q "CRITICAL" docker-scan.json; then
            echo "âŒ VulnÃ©rabilitÃ©s critiques dans lâ€™image Docker !"
            exit 1
          fi

      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: docker-scan-report
          path: docker-scan.json
  # 5ï¸âƒ£ DAST - Test dynamique OWASP ZAP
  dast:
    name: ğŸŒ DAST - Nikto Web Vulnerability Scan
    runs-on: ubuntu-latest
    needs: docker_scan
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ ExÃ©cuter un scan Nikto
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y nikto
          nikto -h http://testphp.vulnweb.com -output nikto_report.txt

      - name: ğŸ“¤ Upload du rapport Nikto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nikto-report
          path: nikto_report.txt

  # 6ï¸âƒ£ SAST Cloud - Qodana
  qodana:
    name: ğŸ” Qodana Cloud Analysis
    runs-on: ubuntu-latest
    needs: [sast, sca, docker_scan, dast, secrets]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Run Qodana Scan
        uses: JetBrains/qodana-action@v2024.1.4
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}

      - name: ğŸ“¤ Upload Qodana Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qodana-report
          path: qodana/report/
  notify_email:
    name: ğŸ“§ Send email notification
    needs: [semgrep_scan, trivy_scan, qodana_scan]   # adapte selon ton pipeline
    if: failure()   # envoie seulement si vulnÃ©rabilitÃ©s trouvÃ©es
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“§ Send email alert
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ğŸš¨ DevSecOps Scan Failed"
          body: |
            Un ou plusieurs scans ont Ã©chouÃ© :
            - Semgrep
            - Trivy
            - Qodana
            VÃ©rifie les logs sur GitHub Actions.
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
