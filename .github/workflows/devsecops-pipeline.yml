name: üåê DevSecOps ‚Äì Full Security Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # 1Ô∏è‚É£ SAST - Semgrep (bloquant)
  sast:
    name: üîé SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep and enforce policy
        run: |
          semgrep --config=.semgrep/java-password-sql.yml --json --output=semgrep-report.json
          if grep -q '"check_id"' semgrep-report.json; then
            echo "‚ùå Vuln√©rabilit√©s d√©tect√©es par Semgrep !"
            exit 1
          else
            echo "‚úÖ Aucun probl√®me d√©tect√© par Semgrep."
          fi

      - name: Upload Semgrep reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep-report.json

  # 2Ô∏è‚É£ SCA - OWASP Dependency-Check (bloquant)
  dependency_check:
    name: üß© SCA - OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Dependency-Check
        run: |
          DC_VER="10.0.3"
          wget -q "https://github.com/jeremylong/DependencyCheck/releases/download/v${DC_VER}/dependency-check-${DC_VER}-release.zip" -O dc.zip
          unzip -q dc.zip -d dc

      - name: Run Dependency-Check
        run: |
          chmod +x dc/dependency-check/bin/dependency-check.sh
          ./dc/dependency-check/bin/dependency-check.sh \
            --project "DevSecOps-Demo" \
            --scan . \
            --format "ALL" \
            --out dependency-check

      - name: Fail if CRITICAL vulnerabilities exist
        run: |
          if grep -q "CRITICAL" dependency-check/dependency-check-report.json; then
            echo "üö® Vuln√©rabilit√©s critiques d√©tect√©es dans les d√©pendances !"
            exit 1
          else
            echo "‚úÖ Aucune vuln√©rabilit√© critique d√©tect√©e."
          fi

      - name: Upload Dependency-Check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check/dependency-check-report.*

  # 3Ô∏è‚É£ Docker Image Scan - Trivy (bloquant)
  docker_scan:
    name: üê≥ Docker Build & Trivy
    runs-on: ubuntu-latest
    needs: dependency_check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t devsecops-demo:latest .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@v0.16.0
        with:
          image-ref: devsecops-demo:latest
          format: json
          output: trivy-report.json
          exit-code: '1' # bloque si vuln√©rabilit√©s d√©tect√©es
          scan-type: image

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

  # 4Ô∏è‚É£ DAST - OWASP ZAP (bloquant si trop d‚Äôalertes)
  dast:
    name: üåê DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: docker_scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP baseline
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://testphp.vulnweb.com"
          cmd_options: "-a -T 5 -m 10" # bloque si plus de 10 alertes
          allow_issue_writing: false

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_md.md
            report_json.json

  # 5Ô∏è‚É£ Secrets Scan - Gitleaks (bloquant)
  secrets_scan:
    name: üîê Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: dast
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source . --report-format json --report-path=gitleaks-report.json

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # 6Ô∏è‚É£ SonarQube Scan (optionnel, non-bloquant)
  sonar:
    name: üîç SonarQube Scan
    runs-on: ubuntu-latest
    needs: [sast, dependency_check, docker_scan, dast, secrets_scan]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SonarQube analysis
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=SonarQube-GITHUB
            -Dsonar.projectName=SonarQube-GITHUB

      - name: End SonarQube Scan
        run: echo "SonarQube scan termin√© (r√©sultats visibles dans ton instance)."

