name: üîê DevSecOps - Full Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# üîí Permissions n√©cessaires pour GitHub Actions
permissions:
  contents: read
  actions: write
  security-events: write

jobs:
  # 1Ô∏è‚É£ SAST - Analyse statique du code source
  sast:
    name: üîç SAST - Semgrep Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Installer Semgrep
        run: pip install semgrep

      - name: üöÄ Ex√©cuter l'analyse Semgrep
        run: |
          semgrep --config=.semgrep/java-password-sql.yml --json -o semgrep-report.json || true
          semgrep --config=.semgrep/java-password-sql.yml --text -o semgrep-report.txt || true

      - name: ‚õî √âchec si vuln√©rabilit√©s d√©tect√©es
        run: |
          if grep -q '"check_id"' semgrep-report.json; then
            echo "‚ùå Vuln√©rabilit√©s d√©tect√©es par Semgrep !"
            exit 1
          fi

      - name: üì§ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep-report.json
            semgrep-report.txt

  # 2Ô∏è‚É£ SCA - Analyse des d√©pendances
  sca:
    name: üß© SCA - OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ‚öôÔ∏è Installer OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip
          unzip dependency-check-10.0.3-release.zip
          mv dependency-check /opt/dependency-check
          chmod +x /opt/dependency-check/bin/dependency-check.sh

      - name: üöÄ Lancer Dependency Check
        run: |
          /opt/dependency-check/bin/dependency-check.sh \
            --project "DevSecOps-Demo" \
            --scan ./ \
            --format "ALL" \
            --out dependency-report || true

      - name: ‚õî √âchec si vuln√©rabilit√©s critiques
        run: |
          if grep -q "CRITICAL" dependency-report/dependency-check-report.html; then
            echo "‚ùå Vuln√©rabilit√©s critiques d√©tect√©es !"
            exit 1
          fi

      - name: üì§ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report

  # 3Ô∏è‚É£ Secrets - Analyse de fuites de secrets
  secrets:
    name: üîí Secrets Scan - Gitleaks
    runs-on: ubuntu-latest
    needs: sca
    steps:
      - uses: actions/checkout@v4

      - name: üöÄ Ex√©cuter Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format json --report-path gitleaks-report.json || true

      - name: ‚õî √âchec si secrets trouv√©s
        run: |
          if grep -q '"Description"' gitleaks-report.json; then
            echo "‚ùå Secrets d√©tect√©s dans le d√©p√¥t !"
            exit 1
          fi

      - name: üì§ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # 4Ô∏è‚É£ Docker Scan - Trivy (scan de l‚Äôimage container)
  docker_scan:
    name: üê≥ Docker Image Scan - Trivy
    runs-on: ubuntu-latest
    needs: secrets
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: ‚öôÔ∏è Construire l‚Äôimage Docker
        run: docker build -t devsecops-demo:latest .

      - name: üöÄ Lancer le scan Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "devsecops-demo:latest"
          format: "json"
          output: "docker-scan.json"
          exit-code: "0"

      - name: ‚õî √âchec si vuln√©rabilit√©s critiques
        run: |
          if grep -q "CRITICAL" docker-scan.json; then
            echo "‚ùå Vuln√©rabilit√©s critiques dans l‚Äôimage Docker !"
            exit 1
          fi

      - name: üì§ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: docker-scan-report
          path: docker-scan.json

  # 5Ô∏è‚É£ DAST - Test dynamique OWASP ZAP
  dast:
    name: üåê DAST - OWASP ZAP Baseline
    runs-on: ubuntu-latest
    needs: docker_scan
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Lancer un scan OWASP ZAP (site de test)
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: "http://testphp.vulnweb.com"
          cmd_options: "-a -T 5"
          allow_issue_writing: false     # √©vite la cr√©ation automatique d‚Äôissue
          upload_artifact: false         # üöÄ d√©sactive l‚Äôupload int√©gr√© de ZAP

      - name: üì§ Upload manuel du rapport ZAP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report               # nom propre et stable
          path: |
            report_html.html
            report_md.md
            report_json.json

  # 6Ô∏è‚É£ SonarQube Scan - Analyse qualit√© et s√©curit√©
  sonar:
    name: üîç SonarQube Scan
    runs-on: ubuntu-latest
    needs: [sast, sca, secrets, docker_scan, dast]
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üöÄ Ex√©cuter l‚Äôanalyse SonarQube
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=SonarQube-GITHUB
            -Dsonar.projectName=SonarQube-GITHUB

      - name: ‚úÖ Fin du scan
        run: echo "Analyse SonarQube termin√©e. Consulte les r√©sultats sur ton instance."
