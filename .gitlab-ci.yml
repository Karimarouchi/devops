stages:
  - sast
  - sca
  - docker_scan
  - secrets
  - report

variables:
    SEMGREP_APP_TOKEN: $SEMGREP_APP_TOKEN
  SONAR_HOST_URL: "http://192.168.50.4:9000"
  SONAR_LOGIN: $SONAR_TOKEN

# --- 1Ô∏è‚É£ SAST : Analyse du code avec Semgrep ---
sast:
  stage: sast
  image: python:3.10
  script:
    - pip install semgrep
    - semgrep --config=.semgrep/java-password-sql.yml --json -o semgrep-report.json || true
    - semgrep ci --json -o semgrep-report.json
artifacts:
    when: always
    paths:
      - semgrep-report.json
    expire_in: 7 days

# --- 2Ô∏è‚É£ SCA : D√©pendances avec OWASP Dependency-Check ---
sca:
  stage: sca
  image: openjdk:17-jdk
  script:
    - apt-get update && apt-get install -y wget unzip
    - wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.3/dependency-check-10.0.3-release.zip -O depcheck.zip
    - unzip -o -q depcheck.zip
    - ./dependency-check/bin/dependency-check.sh --project "MyApp" --scan . --format "JSON" --out .
  artifacts:
    when: always
    paths:
      - dependency-check-report.json
    expire_in: 7 days

# --- 3Ô∏è‚É£ Docker Scan avec Trivy ---
docker_scan:
  stage: docker_scan
  image: aquasec/trivy:latest
  script:
    - trivy fs . --format json --output trivy-report.json || true
  artifacts:
    when: always
    paths:
      - trivy-report.json
    expire_in: 7 days

# --- 4Ô∏è‚É£ Secrets Scan avec Gitleaks ---
secrets:
  stage: secrets
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true
  artifacts:
    when: always
    paths:
      - gitleaks-report.json
    expire_in: 7 days

# --- 5Ô∏è‚É£ SonarQube (Optionnel mais recommand√©) ---
sonarqube:
  stage: report
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - sonar-scanner -Dsonar.projectKey=devops
                    -Dsonar.sources=.
                    -Dsonar.host.url=$SONAR_HOST_URL
                    -Dsonar.login=$SONAR_LOGIN
  only:
    - main

# --- 6Ô∏è‚É£ Reporting & Alerting ---
report:
  stage: report
  image: python:3.10
  script:
    - echo "üîî G√©n√©ration du rapport global..."
    - echo "üìÑ SAST : semgrep-report.json"
    - echo "üìÑ SCA : dependency-check-report.json"
    - echo "üìÑ Trivy : trivy-report.json"
    - echo "üìÑ Gitleaks : gitleaks-report.json"
  artifacts:
    when: always
    paths:
      - semgrep-report.json
      - dependency-check-report.json
      - trivy-report.json
      - gitleaks-report.json
    expire_in: 1 week
